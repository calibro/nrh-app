name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Sync workspace to server
      uses: appleboy/scp-action@v1
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        source: "."
        target: "~/nrh-app"
        rm: true

    - name: Deploy to server
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          cd ~/nrh-app
          
          # Stop old container
          docker stop nrhapp 2>/dev/null || true
          docker rm nrhapp 2>/dev/null || true
          
          # Build and run new container
          docker build -t nrhapp .
          docker run -d --name nrhapp --restart unless-stopped -p 8085:8085 nrhapp
          
          # Check if running
          sleep 3
          docker ps | grep nrhapp || exit 1